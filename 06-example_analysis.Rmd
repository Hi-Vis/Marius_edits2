# An Example Analysis

Now that we've covered the fundamentals of R, we can go through
an example analysis start to finish to see everything works in practice.
We'll use an example dataset from the `carData` package, a study
looking at personality and how it relates to people's decision to volunteer
as a research participant.

We'll run through some different steps, working towards some simple analyses
of the data. In this format, the steps will be broken up in different chunks,
but normally they would all be saved in a single script which could
be run in one go. In a script, it can be useful to label each
section with a commented heading - if you end a comment line with at least 4 `#`'s,
RStudio automatically treats it as a heading, and you'll be able to jump
to that section:

```{r comment_header_example}
### Load libraries #####
# Code goes here

### Load data ##########
# More code here
```

First, we'll make sure we have the `carData` package installed - please
copy and run this code in your console:

```{r install_cardata, eval=FALSE}
if (! require("carData", character.only = TRUE)) {
  install.packages(c("car", "carData"))
}
```

## Loading libraries

The first step in any analyses is to load any libraries we're going
to use. If you're part way through an analysis and realise you're going
to use another library, go back and add it to the top of the script.

For now, we're only using the `ggplot2` library, which produces
nice looking plots.

```{r load_libraries}
library(ggplot2)
```

## Loading data

Normally, this is where you would read your data in from an external
file, using something like `readr::read_csv()` or `haven::read_spss()`.
Instead, we'll just take the existing `carData::Cowles` data and
assign a copy of it to a new variable name.

```{r load_data}
# A short, simple name for you main dataset is nice because you'll
#   probably have to type it out a lot
cow = carData::Cowles
```

This is a reasonably big dataset, with 1421 rows (visible in the "Environment"
pane in RStudio, or you can get it with `nrow(cow)`). If you just print
the data in the console by entering `cow`, you'll get a lot of output
(but luckily not all 1000+ rows). Instead, it's often best to use
`head(data)` to see the first few rows when you just want to look at the 
 basic format of your data:

```{r data_head_example}
head(cow)
```

We can check the format of the data using `str()`, short for
**structure**:

```{r check_data_structure}
str(cow)
```

All the columns have a sensible format here: the two personality
scores are `integer`s (whole numbers), and the two categorical
variables are `factor`s[^factor-warning]. If you need to change
the type of any variables in your data, it's best to do it
right after loading the data, so you can work with consistent
types from that point on.

[^factor-warning]: Some of the most common problems in R result
from text data that should just be in `character` format being
stored as `factor`. `factor` should only be used if you
have categorical variables with a fixed number of levels (usually
a small number). If you have text columns, check how they've
been stored.

## Recoding

Let's go through some basic recoding. First we'll code
people as either "introverts" or "extroverts" based
on their scores:

```{r simple_recode_example}
cow$personality_type = ifelse(
    test = cow$extraversion > cow$neuroticism,
    yes = "Extravert",
    no = "Introvert"
)
# Make it a factor
cow$personality_type = factor(
    cow$personality_type,
    levels = c("Introvert", "Extravert")
)
```

We've used the `ifelse()` function, which makes it easy to create
a vector based on a test, picking values from the `yes` argument
when the test is `TRUE` and from the `no` argument when the test
is `FALSE`:

![](Images/IfElse.png "ifelse demonstration")

We'll also code neuroticism and extraversion
as either "low" or "high" based on whether they're
above the mean:

```{r low_high_recodes}
cow$high_neuroticism = ifelse(
    cow$neuroticism > mean(cow$neuroticism),
    "High",
    "Low"
)
cow$high_neuroticism = factor(
    cow$high_neuroticism,
    levels = c("Low", "High")
)
```

Since the example dataset we're using doesn't have
quite enough variables, let's also create a new one
(not recommended in actual data):

```{r create_var_example}
# Advanced code: run this but don't worry too much about what
#   it's doing
set.seed(1)
cow$depression = round(
  19 + 
  0.5 * cow$neuroticism +
  -0.8 * cow$extraversion +
  0.5 * (cow$sex == "female") +
  rnorm(nrow(cow), sd = 3)
)
```

## Descriptive Statistics

Before doing any actual analysis it's always good to use
descriptive statistics to look at the data and get a sense
of what each variable looks like.

### Quick data summary

You can get a good overview of the entire dataset using
`summary()`:

```{r summary_df_example}
summary(cow)
```

### Frequency tables

You can count frequencies of categorical variables with
`table()`:

```{r freq_table_example}
table(cow$sex)
table(cow$volunteer)
```

### Histograms: distributions of continuous variables

Histograms are good for checking the range of scores
for a continuous variable to see if there are any
issues like skew, outlying scores etc.. Use `hist()`
to plot the histogram for a variable:

```{r hist_example, fig.width=4, fig.height=3}
hist(cow$neuroticism)
```

### Scatterplots: relationship between two continuous variables

Scatterplots are useful for getting a sense of whether or
not there's a relationship between two continuous variables.
The basic `plot()` function in R is quite flexible, so to
produce a scatter plot we just give it the two variables
and use `type = 'p'` to indicate we want to plot points.

```{r scatter_example, fig.width = 5, fig.height = 4}
plot(cow$neuroticism, cow$depression, type='p')
```

This plot doesn't look great - we'll cover ways to produce
better plots later. But you can see there's a positive
correlation between neuroticism and depression.[^fakedata]
To check the correlation we can use `cor()`:

```{r correlation_example}
cor(cow$neuroticism, cow$depression)
```

[^fakedata]: Keen readers will notice that the positive correlation is
there because we put it there when generating the fake depression
variable.

## Analysis

## Utterly pointless flashy stuff

Impress your friends/supervisors!

```{r rayshade_code, eval=FALSE}
# install with 
# devtools::install_github("tylermorganwall/rayshader")
library(rayshader)
library(rgl)

hex_gg = ggplot(cow, aes(x = extraversion, y = neuroticism)) +
    stat_bin_hex(aes(fill = stat(ndensity)), 
                  geom = "hex", bins = 10) +
    scale_fill_viridis_c(option = "B") +
    labs(x = "Extraversion", y = "Neuroticism", fill = "") +
    theme_minimal()    
hex_gg

plot_gg(
    hex_gg,
    width = 4, height = 4,
    multicore = TRUE,
    preview = FALSE,
    windowsize = c(800, 800)
)
render_movie("Images/flashy.mp4")
```